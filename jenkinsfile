pipeline {
    agent any

    environment {
        // Testcontainers issues fix
        TESTCONTAINERS_RYUK_DISABLED = "true"
        TESTCONTAINERS_CHECKS_DISABLE = "true"
        SPRING_DOCKER_COMPOSE_SKIP_IN_TESTS = "true"

        // Dynamically load Maven project info
        PROJECT_VERSION = sh(script: "mvn help:evaluate -Dexpression=project.version -q -DforceStdout", returnStdout: true).trim()
        PROJECT_ARTIFACT = sh(script: "mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout", returnStdout: true).trim()

        // Docker registry settings
        REGISTRY_CREDENTIALS = "docker-hub-creds"
        DOCKER_IMAGE = "venuboddu2005/${PROJECT_ARTIFACT}"
    }

    stages {

        stage("Build Code") {
            steps {
                echo "üì¶ Building code..."
                sh './mvnw clean package -DskipTests'
            }
        }

        stage("Run Unit Tests") {
            steps {
                echo "üß™ Running Unit Tests..."
                sh """
                    ./mvnw test \
                    -Dspring.docker.compose.skip.in-tests=true \
                    -Dtest='*Tests,!*IntegrationTests,*Test'
                """
            }
        }

        stage("SonarQube Scan") {
            steps {
                echo "üîç Running SonarQube Scan..."
                script {
                    withSonarQubeEnv('dev-sonar-01') {
                        sh """
                            sonar-scanner \
                                -Dsonar.projectKey=${PROJECT_ARTIFACT} \
                                -Dsonar.projectName=${PROJECT_ARTIFACT} \
                                -Dsonar.projectVersion=${PROJECT_VERSION} \
                                -Dsonar.sources=src \
                                -Dsonar.java.binaries=target/classes \
                                -Dsonar.sourceEncoding=UTF-8
                        """
                    }
                }
            }
        }

        stage("Sonar Quality Gate") {
            steps {
                echo "üö¶ Checking Sonar Quality Gate..."
                script {
                    timeout(time: 3, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        if (qg.status != "OK") {
                            error "‚ùå Quality Gate Failed: ${qg.status}"
                        }
                    }
                }
            }
        }

        stage("Docker Build") {
            steps {
                echo "üê≥ Building Docker Image..."
                sh """
                    docker build -t ${DOCKER_IMAGE}:${PROJECT_VERSION} .
                """
            }
        }

        stage("Docker Push") {
            steps {
                echo "üì§ Pushing Docker Image..."
                script {
                    withCredentials([usernamePassword(credentialsId: REGISTRY_CREDENTIALS,
                             usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        sh '''
                            echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin
                            docker push '"${DOCKER_IMAGE}"':'"${PROJECT_VERSION}"'
                        '''
                    }
                }
            }
        }

        stage("Deploy to Server") {
            steps {
                echo "üöÄ Deploying Application..."
                sh """
                    docker rm -f petclinic || true
                    docker pull ${DOCKER_IMAGE}:${PROJECT_VERSION}
                    docker run -d --name petclinic -p 8080:8080 ${DOCKER_IMAGE}:${PROJECT_VERSION}
                """
            }
        }
    }

    post {
        success {
            echo "üéâ CI/CD Pipeline Completed Successfully!"
        }
        failure {
            echo "‚ùå CI/CD Pipeline Failed!"
        }
    }
}
